<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyLife Idly</title>

    <!-- iOS specifics -->
    <link rel="apple-touch-icon" href="mylife-idly.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- This helps to track errors on mobile (which have no easily accessible dev tools) -->
    <script>
      window.onerror = function (msg, url, lineNo, columnNo, error) {
        var string = msg.toLowerCase();
        var substring = "script error";
        var message = [
          'Message: ' + msg,
          'URL: ' + url,
          'Line: ' + lineNo,
          'Column: ' + columnNo,
          'Error object: ' + JSON.stringify(error)
        ].join(' - ');

        alert(message);

        return false;
      };
    </script>

    <style>
      html {
        height:100%;
        margin: 0;
        padding: 0;
      }
      body {
        height:100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: relative;
      }
      iframe {
        border: 0;
        width: 100vw;
        height: 100vh;
        display: block;
        position: fixed;
        top:0; left:0;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      iframe.visible {
        opacity: 1;
        pointer-events: auto;
      }

    </style>
  </head>
  <body>
    <iframe id="slideshowFrame" class="visible" src="/slideshow" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
    <iframe id="targetFrame" src="/target/" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>

    <script>
      (function() {
        var IDLE_TIMEOUT = 15000; // 15 seconds
        var slideshowFrame = document.getElementById('slideshowFrame');
        var targetFrame = document.getElementById('targetFrame');
        var idleTimer = null;
        var current = 'slideshow'; // 'slideshow' or 'target'

        function showTarget() {
          if (current === 'target') {
            return;
          }

          // Switch to target frame (instant)
          targetFrame.className = 'visible';
          slideshowFrame.className = '';
          current = 'target';
        }

        function showSlideshow() {
          if (current === 'slideshow') {
            return;
          }

          // Switch to slideshow frame (instant)
          slideshowFrame.className = 'visible';
          targetFrame.className = '';
          current = 'slideshow';
        }

        function resetIdleTimer() {
          if (idleTimer) {
            clearTimeout(idleTimer);
          }
          
          // If user interacted, wait IDLE_TIMEOUT and go back to slideshow
          idleTimer = setTimeout(function() {
            showSlideshow();
          }, IDLE_TIMEOUT);
        }

        // When user interacts: show target if needed and reset idle timer
        function onUserActivity(e) {
          console.log('user activity detected:', e.type, e.target);
          
          showTarget();
          resetIdleTimer();
        }

        // Function to add event listeners to iframe content
        function addIframeEventListeners(frame) {
          try {
            var iframeDoc = frame.contentDocument || frame.contentWindow.document;
            if (iframeDoc) {
              // Add event listeners to iframe document
              iframeDoc.addEventListener('click', onUserActivity, true);
              iframeDoc.addEventListener('touchstart', onUserActivity, true);
              iframeDoc.addEventListener('mousedown', onUserActivity, true);
              iframeDoc.addEventListener('keydown', onUserActivity, true);
              
              // Also listen on iframe window
              var iframeWin = frame.contentWindow;
              if (iframeWin) {
                iframeWin.addEventListener('click', onUserActivity, true);
                iframeWin.addEventListener('touchstart', onUserActivity, true);
                iframeWin.addEventListener('mousedown', onUserActivity, true);
                iframeWin.addEventListener('keydown', onUserActivity, true);
              }
              
              console.log('Added event listeners to iframe content');
            }
          } catch (e) {
            console.log('Could not access iframe content (cross-origin):', e.message);
          }
        }

        slideshowFrame.addEventListener('load', function() {
          addIframeEventListeners(slideshowFrame);
        });

        targetFrame.addEventListener('load', function() {
          addIframeEventListeners(targetFrame);
          if (current === 'target') {
            resetIdleTimer();
          }
        });

        resetIdleTimer();
      })();
    </script>
  </body>
</html>
