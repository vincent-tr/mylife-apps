<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Idly â€” Controller</title>
  <style>
    html,body {
      margin:0; padding:0; height:100%; width:100%; background:black;
      -webkit-text-size-adjust:100%;
    }
    iframe {
      border:0;
      width:100%;
      height:100%;
      display:block;
    }
    /* optional overlay button - small hint to tap */
    #hint {
      position:fixed;
      left:12px;
      bottom:12px;
      padding:6px 10px;
      background:rgba(0,0,0,0.5);
      color:#fff;
      font-family: sans-serif;
      font-size:14px;
      border-radius:6px;
      z-index:9999;
      pointer-events:none;
      opacity:0.6;
    }
  </style>
</head>
<body>
  <iframe id="frame" src="/slideshow" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
  <div id="hint">Tap to open controls</div>

  <script>
    (function() {
      var IDLE_TIMEOUT = 15000; // 15 seconds
      var frame = document.getElementById('frame');
      var idleTimer = null;
      var current = 'slideshow'; // 'slideshow' or 'home'

      function showHome() {
        if (current !== 'home') {
          // Load the control UI in the iframe
          frame.src = '{{target}}';
          current = 'home';
        }
      }

      function showSlideshow() {
        if (current !== 'slideshow') {
          frame.src = '/slideshow';
          current = 'slideshow';
        }
      }

      function resetIdleTimer() {
        if (idleTimer) {
          clearTimeout(idleTimer);
        }
        // If user interacted, wait IDLE_TIMEOUT and go back to slideshow
        idleTimer = setTimeout(function() {
          showSlideshow();
        }, IDLE_TIMEOUT);
      }

      // When user touches or clicks anywhere: show home and reset idle
      function onUserActivity(e) {
        // avoid focusing elements inside iframe repeatedly
        showHome();
        resetIdleTimer();
      }

      // Mobile Safari uses touchstart; desktop may use mousedown
      document.addEventListener('touchstart', onUserActivity, false);
      document.addEventListener('mousedown', onUserActivity, false);

      // Also if the iframe navigates to something else on its own (like clicking inside),
      // we still want to start the idle timer if user is active:
      frame.addEventListener('load', function() {
        // If the iframe is the home app, start the idle timer so it returns later
        if (current === 'home') {
          resetIdleTimer();
        }
      });

      // initialize idle countdown immediately
      resetIdleTimer();

      // If the home app sends a message to return to the slideshow,
      // this postMessage handler will respond accordingly.
      window.addEventListener('message', function(evt) {
        if (evt && evt.data === 'idly:show-slideshow') {
          showSlideshow();
        }
      }, false);
    })();
  </script>
</body>
</html>
